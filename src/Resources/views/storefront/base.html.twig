{% sw_extends '@Storefront/storefront/base.html.twig' %}

{# Inject context token consistently using the script block where context is reliable #}
{% block base_body_script %}
    {{ parent() }}
    {# No server-side context injection to prevent 500 errors #}
{% endblock %}

{% block base_body_inner %}
    {{ parent() }}
    
    {% if config('AgenticAiSupport.config.enabled') %}
        {# AI Chat Widget #}
        <div id="agentic-ai-chat-widget">
            {# ... (HTML structure remains same) ... #}
            {# Chat Button #}
            <button id="agentic-chat-toggle" class="agentic-chat-toggle" aria-label="Open chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>

            {# Chat Window #}
            <div id="agentic-chat-container" class="agentic-chat-container" style="display: none;">
                {# Chat Header #}
                <div class="agentic-chat-header">
                    <div class="agentic-chat-header-content">
                        <div class="agentic-chat-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                        </div>
                        <div class="agentic-chat-title">
                            <h3>{{ config('AgenticAiSupport.config.chatTitle') }}</h3>
                            <span class="agentic-chat-status">Online</span>
                        </div>
                    </div>
                    <button id="agentic-chat-close" class="agentic-chat-close" aria-label="Close chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                {# Chat Messages #}
                <div id="agentic-chat-messages" class="agentic-chat-messages">
                    <div class="agentic-message agentic-message-bot">
                        <div class="agentic-message-content">
                            {{ config('AgenticAiSupport.config.welcomeMessage') }}
                        </div>
                    </div>
                </div>

                {# Typing Indicator #}
                <div id="agentic-typing-indicator" class="agentic-typing-indicator" style="display: none;">
                    <div class="agentic-typing-dot"></div>
                    <div class="agentic-typing-dot"></div>
                    <div class="agentic-typing-dot"></div>
                </div>

                {# Chat Input #}
                <div class="agentic-chat-input-container">
                    <form id="agentic-chat-form">
                        <input 
                            type="text" 
                            id="agentic-chat-input" 
                            class="agentic-chat-input" 
                            placeholder="Type your message..."
                            autocomplete="off"
                        />
                        <button type="submit" class="agentic-chat-send" aria-label="Send message">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {# Inline JavaScript for Chat Widget #}
        <script>
            (function() {
                if (!window.agenticAiConfig || !window.agenticAiConfig.enabled) return;

                // Helper to get cookie value
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return null;
                }

                const ChatWidget = {
                    config: window.agenticAiConfig,
                    // Get context token from cookie ONLY - safest method
                    contextToken: getCookie('sw-context-token') || sessionStorage.getItem('agenticAiContext') || null,
                    isOpen: false,
                    elements: {},

                    init() {
                        this.elements = {
                            toggle: document.getElementById('agentic-chat-toggle'),
                            close: document.getElementById('agentic-chat-close'),
                            container: document.getElementById('agentic-chat-container'),
                            messages: document.getElementById('agentic-chat-messages'),
                            form: document.getElementById('agentic-chat-form'),
                            input: document.getElementById('agentic-chat-input'),
                            typingIndicator: document.getElementById('agentic-typing-indicator')
                        };

                        this.attachEventListeners();
                        this.applyCustomStyles();

                        // Ensure we have a context token (fetch from backend if needed)
                        this.ensureContextToken();
                    },

                    async ensureContextToken() {
                        // If we already have one (e.g. from session storage), good.
                        // But also try to verify/refresh it from our endpoint to be safe.
                        if (!this.contextToken) {
                            try {
                                const response = await fetch('/agentic-ai/context', {
                                    // headers: { 'X-Requested-With': 'XMLHttpRequest' } // Removed to prevent 403 if header is stripped
                                });
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.token) {
                                        this.contextToken = data.token;
                                        sessionStorage.setItem('agenticAiContext', data.token);
                                    }
                                }
                            } catch (e) {
                                console.error('AgenticAI: Failed to fetch context token', e);
                            }
                        }
                    },

                    attachEventListeners() {
                        this.elements.toggle.addEventListener('click', () => this.toggleChat());
                        this.elements.close.addEventListener('click', () => this.toggleChat());
                        this.elements.form.addEventListener('submit', (e) => this.handleSubmit(e));
                    },

                    applyCustomStyles() {
                        const primaryColor = this.config.primaryColor || '#007bff';
                        const position = this.config.position || 'bottom-right';
                        
                        document.documentElement.style.setProperty('--agentic-primary-color', primaryColor);
                        
                        if (position === 'bottom-left') {
                            this.elements.toggle.style.left = '20px';
                            this.elements.toggle.style.right = 'auto';
                            this.elements.container.style.left = '20px';
                            this.elements.container.style.right = 'auto';
                        }
                    },

                    toggleChat() {
                        this.isOpen = !this.isOpen;
                        
                        if (this.isOpen) {
                            this.elements.container.style.display = 'flex';
                            this.elements.toggle.style.display = 'none';
                            this.elements.input.focus();
                        } else {
                            this.elements.container.style.display = 'none';
                            this.elements.toggle.style.display = 'flex';
                        }
                    },

                    async handleSubmit(e) {
                        e.preventDefault();
                        
                        const message = this.elements.input.value.trim();
                        if (!message) return;

                        this.addMessage(message, 'user');
                        this.elements.input.value = '';
                        this.showTypingIndicator();

                        try {
                            const response = await this.sendMessage(message);
                            this.hideTypingIndicator();
                            this.handleResponse(response);
                        } catch (error) {
                            this.hideTypingIndicator();
                            this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                            console.error('Chat error:', error);
                        }
                    },

                    async sendMessage(message) {
                        const payload = {
                            message: message,
                            swAccessKey: this.config.swAccessKey,
                            shopUrl: this.config.shopUrl
                        };

                        if (this.contextToken) {
                            payload.swContextToken = this.contextToken;
                        }

                        const response = await fetch(this.config.apiEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    },

                    handleResponse(response) {
                        if (response.context && response.context.swContextToken) {
                            this.contextToken = response.context.swContextToken;
                            sessionStorage.setItem('agenticAiContext', this.contextToken);
                        }

                        if (response.message) {
                            this.addMessage(response.message, 'bot');
                        }

                        switch (response.type) {
                            case 'product_list':
                                this.renderProductList(response.data);
                                break;
                            case 'product_detail':
                                this.renderProductDetail(response.data);
                                break;
                            case 'order_list':
                                this.renderOrderList(response.data);
                                break;
                        }
                    },

                    addMessage(content, sender) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `agentic-message agentic-message-${sender}`;
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'agentic-message-content';
                        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
                        
                        messageDiv.appendChild(contentDiv);
                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                    renderProductList(data) {
                        if (!data || !data.results || data.results.length === 0) return;

                        const productsContainer = document.createElement('div');
                        productsContainer.className = 'agentic-products-container';

                        data.results.forEach(product => {
                            productsContainer.appendChild(this.createProductCard(product));
                        });

                        if (data.pagination && data.pagination.hasNextPage) {
                            const paginationInfo = document.createElement('div');
                            paginationInfo.className = 'agentic-pagination-info';
                            paginationInfo.textContent = `Showing ${data.results.length} of ${data.pagination.total} products`;
                            productsContainer.appendChild(paginationInfo);
                        }

                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'agentic-message agentic-message-bot';
                        messageDiv.appendChild(productsContainer);
                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                    createProductCard(product) {
                        const card = document.createElement('div');
                        card.className = 'agentic-product-card';

                        const imageUrl = product.imageUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23ddd" width="100" height="100"/%3E%3C/svg%3E';

                        card.innerHTML = `
                            <a href="${product.url || '#'}" class="agentic-product-link" target="_blank">
                                <div class="agentic-product-image">
                                    <img src="${imageUrl}" alt="${product.name}" loading="lazy" />
                                    ${product.stock > 0 ? '' : '<span class="agentic-product-badge out-of-stock">Out of Stock</span>'}
                                </div>
                                <div class="agentic-product-info">
                                    <h4 class="agentic-product-name">${product.name}</h4>
                                    ${product.productNumber ? `<p class="agentic-product-number">${product.productNumber}</p>` : ''}
                                    ${product.options && product.options.length > 0 ? `
                                        <div class="agentic-product-options">
                                            ${product.options.map(opt => `<span class="agentic-option-badge">${opt.option}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="agentic-product-footer">
                                        <span class="agentic-product-price">€${product.price.toFixed(2)}</span>
                                        ${product.stock > 0 ? `<span class="agentic-product-stock">${product.stock} in stock</span>` : ''}
                                    </div>
                                </div>
                            </a>
                        `;
                        return card;
                    },

                    renderProductDetail(product) {
                        if (!product) return;

                        const detailContainer = document.createElement('div');
                        detailContainer.className = 'agentic-product-detail';

                        const imageUrl = product.imageUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23ddd" width="100" height="100"/%3E%3C/svg%3E';

                        detailContainer.innerHTML = `
                            <a href="${product.url || '#'}" class="agentic-product-detail-link" target="_blank">
                                <div class="agentic-product-detail-image">
                                    <img src="${imageUrl}" alt="${product.name}" />
                                </div>
                                <div class="agentic-product-detail-info">
                                    <h3>${product.name}</h3>
                                    ${product.productNumber ? `<p class="agentic-product-number">${product.productNumber}</p>` : ''}
                                    <div class="agentic-product-price-large">€${product.price.toFixed(2)}</div>
                                    ${product.stock !== undefined ? `<p class="agentic-stock-info">${product.stock > 0 ? `${product.stock} in stock` : 'Out of stock'}</p>` : ''}
                                    ${product.options && product.options.length > 0 ? `
                                        <div class="agentic-product-options">
                                            ${product.options.map(opt => `<div><strong>${opt.group}:</strong> ${opt.option}</div>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="agentic-product-cta">
                                        <span>View full details →</span>
                                    </div>
                                </div>
                            </a>
                        `;

                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'agentic-message agentic-message-bot';
                        messageDiv.appendChild(detailContainer);
                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                    renderOrderList(data) {
                        if (!data || !data.results || data.results.length === 0) return;

                        const ordersContainer = document.createElement('div');
                        ordersContainer.className = 'agentic-orders-container';

                        data.results.forEach(order => {
                            const orderCard = document.createElement('div');
                            orderCard.className = 'agentic-order-card';
                            
                            orderCard.innerHTML = `
                                <div class="agentic-order-header">
                                    <span class="agentic-order-number">Order #${order.orderNumber || order.id}</span>
                                    <span class="agentic-order-status agentic-order-status-${(order.status || '').toLowerCase()}">${order.status || 'Unknown'}</span>
                                </div>
                                ${order.date ? `<p class="agentic-order-date">${new Date(order.date).toLocaleDateString()}</p>` : ''}
                                ${order.total ? `<p class="agentic-order-total">Total: €${order.total.toFixed(2)}</p>` : ''}
                                ${order.items ? `<p class="agentic-order-items">${order.items} item(s)</p>` : ''}
                            `;
                            
                            ordersContainer.appendChild(orderCard);
                        });

                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'agentic-message agentic-message-bot';
                        messageDiv.appendChild(ordersContainer);
                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                    showTypingIndicator() {
                        this.elements.typingIndicator.style.display = 'flex';
                        this.scrollToBottom();
                    },

                    hideTypingIndicator() {
                        this.elements.typingIndicator.style.display = 'none';
                    },

                    scrollToBottom() {
                        setTimeout(() => {
                            this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
                        }, 100);
                    }
                };

                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => ChatWidget.init());
                } else {
                    ChatWidget.init();
                }
            })();
        </script>
    {% endif %}
{% endblock %}
