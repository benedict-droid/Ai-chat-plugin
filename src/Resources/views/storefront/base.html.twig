{% sw_extends '@Storefront/storefront/base.html.twig' %}

{# Inject context token consistently using the script block where context is reliable #}
{% block base_body_script %}
    {{ parent() }}
    {# No server-side context injection to prevent 500 errors #}
{% endblock %}

{% block base_body_inner %}
    {{ parent() }}
    
    {% if config('AgenticAiSupport.config.enabled') %}
        {# AI Chat Widget - V2 (Updated IDs to bypass cache/old JS) #}
        <div id="agentic-ai-chat-widget-v2">
            {# Chat Button #}
            <button id="agentic-chat-toggle-v2" class="agentic-chat-toggle" aria-label="Open chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>

            {# Chat Window #}
            <div id="agentic-chat-container-v2" class="agentic-chat-container" style="display: none;">
                {# Chat Header #}
                <div class="agentic-chat-header">
                    <div class="agentic-chat-header-content">
                        <div class="agentic-chat-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                        </div>
                        <div class="agentic-chat-title">
                            <h3>{{ config('AgenticAiSupport.config.chatTitle') }}</h3>
                            <span class="agentic-chat-status">Online</span>
                        </div>
                    </div>
                    <button id="agentic-chat-close-v2" class="agentic-chat-close" aria-label="Close chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                {# Chat Messages #}
                <div id="agentic-chat-messages-v2" class="agentic-chat-messages">
                    <div class="agentic-message agentic-message-bot">
                        <div class="agentic-message-content">
                            {{ config('AgenticAiSupport.config.welcomeMessage') }}
                        </div>
                    </div>
                </div>

                {# Typing Indicator #}
                <div id="agentic-typing-indicator-v2" class="agentic-typing-indicator" style="display: none;">
                    <div class="agentic-typing-dot"></div>
                    <div class="agentic-typing-dot"></div>
                    <div class="agentic-typing-dot"></div>
                </div>

                {# Chat Input #}
                <div class="agentic-chat-input-container">
                    <form id="agentic-chat-form-v2">
                        <input 
                            type="text" 
                            id="agentic-chat-input-v2" 
                            class="agentic-chat-input" 
                            placeholder="Type your message..."
                            autocomplete="off"
                        />
                        <button type="submit" class="agentic-chat-send" aria-label="Send message">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {# Inline JavaScript for Chat Widget #}
        <script>
            (function() {
                if (!window.agenticAiConfig || !window.agenticAiConfig.enabled) return;

                // Helper to get cookie value
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return null;
                }

                const ChatWidgetV2 = {
                    config: window.agenticAiConfig,
                    // Get context token from cookie ONLY - safest method
                    contextToken: getCookie('sw-context-token') || sessionStorage.getItem('agenticAiContext') || null,
                    isOpen: false,
                    elements: {},

                    init() {
                        this.elements = {
                            toggle: document.getElementById('agentic-chat-toggle-v2'),
                            close: document.getElementById('agentic-chat-close-v2'),
                            container: document.getElementById('agentic-chat-container-v2'),
                            messages: document.getElementById('agentic-chat-messages-v2'),
                            form: document.getElementById('agentic-chat-form-v2'),
                            input: document.getElementById('agentic-chat-input-v2'),
                            typingIndicator: document.getElementById('agentic-typing-indicator-v2')
                        };

                        if (!this.elements.toggle) {
                            console.error('AgenticAI V2: Missing elements');
                            return;
                        }

                        this.attachEventListeners();
                        this.applyCustomStyles();

                        // Ensure we have a context token (fetch from backend if needed)
                        this.ensureContextToken();
                    },

                    async ensureContextToken() {
                        if (!this.contextToken) {
                            try {
                                const response = await fetch('/agentic-ai/context', {
                                    // headers: { 'X-Requested-With': 'XMLHttpRequest' }
                                });
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.token) {
                                        this.contextToken = data.token;
                                        sessionStorage.setItem('agenticAiContext', data.token);
                                    }
                                }
                            } catch (e) {
                                console.error('AgenticAI: Failed to fetch context token', e);
                            }
                        }
                    },

                    attachEventListeners() {
                        this.elements.toggle.addEventListener('click', () => this.toggleChat());
                        this.elements.close.addEventListener('click', () => this.toggleChat());
                        this.elements.form.addEventListener('submit', (e) => this.handleSubmit(e));
                    },

                    applyCustomStyles() {
                        const primaryColor = this.config.primaryColor || '#007bff';
                        const position = this.config.position || 'bottom-right';
                        
                        document.documentElement.style.setProperty('--agentic-primary-color', primaryColor);
                        
                        if (position === 'bottom-left') {
                            this.elements.toggle.style.left = '20px';
                            this.elements.toggle.style.right = 'auto';
                            this.elements.container.style.left = '20px';
                            this.elements.container.style.right = 'auto';
                        }
                    },

                    toggleChat() {
                        this.isOpen = !this.isOpen;
                        
                        if (this.isOpen) {
                            this.elements.container.style.display = 'flex';
                            this.elements.toggle.style.display = 'none';
                            this.elements.input.focus();
                        } else {
                            this.elements.container.style.display = 'none';
                            this.elements.toggle.style.display = 'flex';
                        }
                    },

                    async handleSubmit(e) {
                        e.preventDefault();
                        
                        const message = this.elements.input.value.trim();
                        if (!message) return;

                        this.addMessage(message, 'user');
                        this.elements.input.value = '';
                        this.showTypingIndicator();

                        try {
                            const response = await this.sendMessage(message);
                            this.hideTypingIndicator();
                            this.handleResponse(response);
                        } catch (error) {
                            this.hideTypingIndicator();
                            this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                            console.error('Chat error:', error);
                        }
                    },

                    async sendMessage(message) {
                        const payload = {
                            message: message,
                            swAccessKey: this.config.swAccessKey,
                            shopUrl: this.config.shopUrl
                        };

                        if (this.contextToken) {
                            payload.swContextToken = this.contextToken;
                        }

                        const response = await fetch(this.config.apiEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    },

                    handleResponse(response) {
                        if (response.context && response.context.swContextToken) {
                            this.contextToken = response.context.swContextToken;
                            sessionStorage.setItem('agenticAiContext', this.contextToken);
                        }

                        // Create a unified bubble content container
                        const unifiedContent = document.createElement('div');
                        unifiedContent.className = 'agentic-message-content';
                        unifiedContent.style.display = 'flex';
                        unifiedContent.style.flexDirection = 'column';
                        unifiedContent.style.gap = '8px';
                        
                        let hasContent = false;

                        // 1. Build Data Element (List/Detail)
                        let dataElement = null;
                        switch (response.type) {
                            case 'product_list':
                                if (this.buildProductList) dataElement = this.buildProductList(response.data);
                                else this.renderProductList(response.data); 
                                break;
                            case 'product_detail':
                                if (this.buildProductDetail) dataElement = this.buildProductDetail(response.data);
                                else this.renderProductDetail(response.data);
                                break;
                            case 'order_list':
                                this.renderOrderList(response.data); // Keep legacy
                                break;
                            case 'cart_list':
                                this.renderCartList(response.data); // Keep legacy
                                break;
                        }

                        if (dataElement) {
                            unifiedContent.appendChild(dataElement);
                            hasContent = true;
                        }

                        // 2. Append Text Message
                        if (response.message) {
                            const textDiv = document.createElement('div');
                            // No class 'agentic-message-content' here, as the parent HAS it
                            textDiv.innerHTML = response.message.replace(/\n/g, '<br>');
                            
                            if (dataElement) {
                                textDiv.style.marginTop = '4px';
                                textDiv.style.paddingTop = '8px';
                                textDiv.style.borderTop = '1px solid rgba(0,0,0,0.05)'; // Visual separation
                            }
                            unifiedContent.appendChild(textDiv);
                            hasContent = true;
                        }

                        // 3. Add the unified message to chat
                        if (hasContent) {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'agentic-message agentic-message-bot';
                            // messageDiv handles spacing/alignment, unifiedContent provides the "bubble" look
                            messageDiv.appendChild(unifiedContent);
                            this.elements.messages.appendChild(messageDiv);
                            this.scrollToBottom();
                        }

                        // 4. Render Suggestions LAST
                        if (response.suggestions && Array.isArray(response.suggestions) && response.suggestions.length > 0) {
                            this.renderSuggestions(response.suggestions);
                        }
                    },

                    renderSuggestions(suggestions) {
                        // Use a simple block container for suggestions
                        const suggestionsContainer = document.createElement('div');
                        suggestionsContainer.className = 'agentic-chat-suggestions-container';
                        
                        // Inline styles
                        suggestionsContainer.style.marginTop = '10px';
                        suggestionsContainer.style.marginBottom = '10px';
                        suggestionsContainer.style.display = 'flex';
                        suggestionsContainer.style.flexWrap = 'wrap';
                        suggestionsContainer.style.gap = '8px';
                        suggestionsContainer.style.width = '100%';
                        suggestionsContainer.style.clear = 'both'; 

                        suggestions.forEach(suggestionText => {
                            const chip = document.createElement('div');
                            chip.className = 'agentic-suggestion-chip';
                            chip.textContent = suggestionText;
                            
                            // Inline fallback styles
                            chip.style.padding = '8px 14px';
                            chip.style.backgroundColor = '#e7f5ff';
                            chip.style.color = '#007bff';
                            chip.style.border = '1px solid rgba(0, 123, 255, 0.2)';
                            chip.style.borderRadius = '20px';
                            chip.style.fontSize = '12px';
                            chip.style.cursor = 'pointer';
                            chip.style.whiteSpace = 'nowrap';
                            chip.style.display = 'inline-block'; 
                            chip.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';

                            chip.addEventListener('click', () => {
                                this.elements.input.value = suggestionText;
                                this.elements.form.dispatchEvent(new Event('submit'));
                            });
                            
                            chip.addEventListener('mouseenter', () => {
                                chip.style.backgroundColor = this.config.primaryColor || '#007bff';
                                chip.style.color = 'white';
                            });
                            chip.addEventListener('mouseleave', () => {
                                chip.style.backgroundColor = '#e7f5ff';
                                chip.style.color = '#007bff';
                            });

                            suggestionsContainer.appendChild(chip);
                        });

                        this.elements.messages.appendChild(suggestionsContainer);
                        this.scrollToBottom();
                    },

                    addMessage(content, sender) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `agentic-message agentic-message-${sender}`;
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'agentic-message-content';
                        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
                        
                        messageDiv.appendChild(contentDiv);
                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                    // Replaces renderProductList. Returns HTMLElement or null.
                    buildProductList(data) {
                        if (!data || !data.results || data.results.length === 0) return null;

                        const listContainer = document.createElement('div');
                        listContainer.className = 'agentic-product-list';
                        // Inline styles for the list container
                        listContainer.style.display = 'flex';
                        listContainer.style.flexDirection = 'column';
                        listContainer.style.gap = '6px'; // Reduced gap
                        listContainer.style.width = '100%';

                        data.results.forEach(product => {
                            listContainer.appendChild(this.createProductListItem(product));
                        });
                        
                        return listContainer;
                    },

                    createProductListItem(product) {
                        const item = document.createElement('div');
                        item.className = 'agentic-product-list-item';
                        
                        // Inline styles for list item - COMPACT VERSION
                        item.style.display = 'flex';
                        item.style.justifyContent = 'space-between';
                        item.style.alignItems = 'center';
                        item.style.padding = '8px 12px'; // Reduced padding
                        item.style.backgroundColor = '#fff';
                        item.style.border = '1px solid #e9ecef';
                        item.style.borderRadius = '6px'; // Slightly smaller radius
                        item.style.marginBottom = '0';
                        item.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                        item.style.transition = 'all 0.2s';
                        item.style.cursor = 'pointer'; 
                        
                        // Hover effect
                        item.onmouseenter = () => {
                            item.style.borderColor = this.config.primaryColor || '#007bff';
                            item.style.transform = 'translateY(-1px)';
                            item.style.boxShadow = '0 3px 6px rgba(0,0,0,0.1)';
                        };
                        item.onmouseleave = () => {
                            item.style.borderColor = '#e9ecef';
                            item.style.transform = 'none';
                            item.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                        };

                        const link = document.createElement('a');
                        link.href = product.url || '#';
                        link.target = '_blank';
                        link.textContent = product.name;
                        link.style.textDecoration = 'none';
                        link.style.color = this.config.primaryColor || '#007bff';
                        link.style.fontWeight = '500'; // Slightly lighter weight
                        link.style.fontSize = '13px'; // Smaller font
                        link.style.flexGrow = '1';
                        link.style.marginRight = '8px';
                        link.style.overflow = 'hidden';
                        link.style.textOverflow = 'ellipsis';
                        link.style.display = '-webkit-box';
                        link.style.webkitLineClamp = '2';
                        link.style.webkitBoxOrient = 'vertical';
                        
                        const priceSpan = document.createElement('span');
                        priceSpan.textContent = `€${product.price ? product.price.toFixed(2) : '0.00'}`;
                        priceSpan.style.fontWeight = 'bold';
                        priceSpan.style.color = '#333';
                        priceSpan.style.fontSize = '13px'; // Smaller font
                        priceSpan.style.whiteSpace = 'nowrap';
                        priceSpan.style.backgroundColor = '#f8f9fa';
                        priceSpan.style.padding = '2px 6px'; // Reduced padding
                        priceSpan.style.borderRadius = '4px';

                        item.appendChild(link);
                        item.appendChild(priceSpan);
                        
                        return item;
                    },

                    // Replaces renderProductDetail. Returns HTMLElement or null.
                    buildProductDetail(product) {
                        if (!product) return null;
                        // Reuse the list item logic for detail as requested (minimal detail)
                        return this.createProductListItem(product);
                    },

                    renderOrderList(data) {
                        if (!data || !data.results || data.results.length === 0) return;

                        const ordersContainer = document.createElement('div');
                        ordersContainer.className = 'agentic-orders-container';

                        data.results.forEach(order => {
                            const orderCard = document.createElement('div');
                            orderCard.className = 'agentic-order-card';
                            
                            orderCard.innerHTML = `
                                <div class="agentic-order-header">
                                    <span class="agentic-order-number">Order #${order.orderNumber || order.id}</span>
                                    <span class="agentic-order-status agentic-order-status-${(order.status || '').toLowerCase()}">${order.status || 'Unknown'}</span>
                                </div>
                                ${order.date ? `<p class="agentic-order-date">${new Date(order.date).toLocaleDateString()}</p>` : ''}
                                ${order.total ? `<p class="agentic-order-total">Total: €${order.total.toFixed(2)}</p>` : ''}
                                ${order.items ? `<p class="agentic-order-items">${order.items} item(s)</p>` : ''}
                            `;
                            
                            ordersContainer.appendChild(orderCard);
                        });

                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'agentic-message agentic-message-bot';
                        messageDiv.appendChild(ordersContainer);
                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                     renderCartList(data) {
                        if (!data || !data.results || data.results.length === 0) return;

                        const cartContainer = document.createElement('div');
                        cartContainer.className = 'agentic-products-container';

                        const header = document.createElement('div');
                        header.className = 'agentic-cart-header';
                        header.style.marginBottom = '10px';
                        header.style.fontWeight = 'bold';
                        header.textContent = `Cart Total: €${data.total ? data.total.toFixed(2) : '0.00'}`;
                        cartContainer.appendChild(header);

                        data.results.forEach(item => {
                            const imageUrl = item.imageUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23ddd" width="100" height="100"/%3E%3C/svg%3E';

                            const card = document.createElement('div');
                            card.className = 'agentic-product-card';
                            card.innerHTML = `
                                <div class="agentic-product-link" style="cursor: default; text-decoration: none;">
                                    <div class="agentic-product-image">
                                        <img src="${imageUrl}" alt="${item.name}" loading="lazy" />
                                        <span class="agentic-product-badge" style="background-color: #28a745;">Qty: ${item.quantity}</span>
                                    </div>
                                    <div class="agentic-product-info">
                                        <h4 class="agentic-product-name">${item.name}</h4>
                                        ${item.productNumber ? `<p class="agentic-product-number">${item.productNumber}</p>` : ''}
                                        <div class="agentic-product-footer">
                                            <span class="agentic-product-price">Total: €${item.price.toFixed(2)}</span>
                                            <span class="agentic-product-stock">@ €${item.unitPrice ? item.unitPrice.toFixed(2) : ''} / each</span>
                                        </div>
                                    </div>
                                </div>
                            `;

                            cartContainer.appendChild(card);
                        });

                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'agentic-message agentic-message-bot';
                        messageDiv.appendChild(cartContainer);

                        this.elements.messages.appendChild(messageDiv);
                        this.scrollToBottom();
                    },

                    showTypingIndicator() {
                        this.elements.typingIndicator.style.display = 'flex';
                        this.scrollToBottom();
                    },

                    hideTypingIndicator() {
                        this.elements.typingIndicator.style.display = 'none';
                    },

                    scrollToBottom() {
                        setTimeout(() => {
                            this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
                        }, 100);
                    }
                };

                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => ChatWidgetV2.init());
                } else {
                    ChatWidgetV2.init();
                }
            })();
        </script>
    {% endif %}
{% endblock %}
